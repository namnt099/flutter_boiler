default_platform(:android)

platform :android do
  desc "Build and distribute APK to Firebase"
  lane :deploy_firebase do
    flavor = ENV["FLAVOR"] || "product" # Lấy từ biến môi trường, mặc định là "product"
    UI.message "🚀 Building flavor: #{flavor}" # Kiểm tra giá trị FLAVOR

    env_file = ".env.#{flavor}" 
    
    UI.message "🚀 Env file: #{env_file}"

    gradlew_path = File.expand_path("../gradlew", __dir__)
    unless File.exist?(gradlew_path)
      UI.user_error!("❌ gradlew not found at #{gradlew_path}")
    end
    
    gradle(
      task: "assemble#{flavor.capitalize}Release",
      properties: {
        "target": "lib/main_#{flavor}.dart",
        "envFile": env_file,
        "flavor": flavor
      }
    )

    apk_path = "../build/app/outputs/apk/#{flavor}/release/app-#{flavor}-release.apk"

    firebase_app_distribution(
      app: "1:212347360763:android:3f0583c2edb094672ee75e",
      android_artifact_type: "APK",
      android_artifact_path: apk_path,
      groups: "test",
      release_notes: "Release notes for this #{flavor} build",
      firebase_cli_token: ENV["FIREBASE_TOKEN"]
    )
  end
end
